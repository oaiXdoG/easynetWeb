# EasynetWeb 任务计划

## 任务概览

| 序号 | 任务名称 | 状态 | 子任务数 | 优先级 |
|------|----------|------|----------|--------|
| 0 | 数据库表结构设计 | ✅ 已完成 | 3 | 🔥 最高 |
| 1 | 菜单同步功能开发 | 未开始 | 8 | 🔥 最高 |
| 2 | 接入后端API，删除所有测试数据 | 未开始 | 6 | 高 |
| 3 | 完善项目初始化流程 | 未开始 | 7 | 高 |
| 4 | 用户创建功能 | 未开始 | 7 | 中 |
| 5 | 角色创建功能 | 未开始 | 7 | 中 |
| 6 | 权限管理功能 | 未开始 | 6 | 中 |
| 7 | groupCode菜单调整 | 未开始 | 6 | 低 |

---

## 零、数据库表结构设计（✅ 已完成）

### 设计说明

**系统定位**：公司内部后台管理系统（私有化部署）

**核心特点**：
- 每个公司独立部署、独立数据库
- 一个公司可以创建多个项目
- 用户可以属于多个项目，每个项目下有不同角色
- 菜单和菜单分组是全局的（平台级）
- 权限是项目级的
- 权限在后端 API 层面鉴权，前端不做按钮级控制

### 子任务清单

| 状态 | 子任务 | 相关文件 | 说明 |
|------|--------|----------|------|
| [√] | 0.1 设计 12 张表结构 | `database/schema-optimized.sql` | 完整的表结构设计 |
| [√] | 0.2 添加优化字段 | `database/schema-optimized.sql` | status/created_at/updated_at 等 |
| [√] | 0.3 更新设计文档 | `docs/数据库设计.md` | 完善文档 |

### 表结构总览（12张表）

| 序号 | 表名 | 说明 | 级别 |
|------|------|------|------|
| 1 | sys_user | 用户表 | 全局 |
| 2 | sys_project | 项目表 | 全局 |
| 3 | sys_role | 角色表 | 项目级 |
| 4 | sys_user_project | 用户-项目-角色关系表 | 关系 |
| 5 | sys_menu_group | 菜单分组表 | 全局 |
| 6 | sys_menu | 菜单表 | 全局 |
| 7 | sys_project_menu | 项目启用菜单表 | 关系 |
| 8 | sys_role_menu_group | 角色-菜单分组关系表 | 关系 |
| 9 | sys_role_menu | 角色-菜单关系表 | 关系 |
| 10 | sys_permission | 操作权限表 | 项目级 |
| 11 | sys_role_permission | 角色-权限关系表 | 关系 |
| 12 | sys_operation_log | 操作日志表 | 全局 |

详见：`docs/数据库设计.md`

---

## 一、菜单同步功能开发（优先完成）

### 背景说明

前端 `config/menus.ts` 是菜单配置的唯一数据源，后端数据库需要存储平台菜单数据（`sys_menu_group` 和 `sys_menu` 表）供超管创建项目时选择。因此需要开发一个"同步菜单"功能，让超管可以将前端配置同步到数据库。

### 子任务清单

| 状态 | 子任务 | 相关文件 | 说明 |
|------|--------|----------|------|
| [ ] | 1.1 定义同步API类型 | `src/types/menu.ts` | 添加 SyncMenusRequest/Response 类型定义 |
| [ ] | 1.2 添加菜单格式化工具函数 | `src/config/menus.ts` | 将 platformMenus 转换为同步API所需格式 |
| [ ] | 1.3 添加同步API接口 | `src/api/system/index.ts` | 新增 syncMenus 函数 |
| [ ] | 1.4 在项目管理页面添加同步按钮 | `src/views/System/Project.vue` | 仅超管可见 |
| [ ] | 1.5 实现同步逻辑 | `src/views/System/Project.vue` | 点击按钮调用API |
| [ ] | 1.6 添加加载状态和错误处理 | `src/views/System/Project.vue` | loading + 错误提示 |
| [ ] | 1.7 后端API开发 | 后端 | POST /api/admin/sync-menus |
| [ ] | 1.8 测试同步功能 | - | 验证数据库数据 |

### 详细说明

#### 1.1 定义同步API类型

```typescript
// src/types/menu.ts
export interface SyncMenusRequest {
  groups: Array<{
    groupCode: string
    groupTitle: string
    sortOrder: number
  }>
  menus: Array<{
    groupCode: string
    menuCode: string
    menuName: string
    icon: string
    path: string
    component: string
    sortOrder: number
  }>
}

export interface SyncMenusResponse {
  success: boolean
  message: string
  data: {
    groups: { added: number; updated: number; deleted: number }
    menus: { added: number; updated: number; deleted: number }
    total: { groups: number; menus: number }
  }
}
```

#### 1.7 后端同步逻辑

1. **验证权限**：确保调用者是超级管理员
2. **同步分组**：对比 sys_menu_group 表，执行增删改
3. **同步菜单**：对比 sys_menu 表，通过 groupCode 找到 group_id
4. **删除检查**：删除前检查是否被 sys_project_menu/sys_role_menu 引用
5. **事务执行**：所有变更在一个事务中完成

---

## 二、接入后端API，删除所有测试数据

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 2.1 确认后端API基础URL和接口文档 | - |
| [ ] | 2.2 更新baseURL配置 | `src/api/request.ts` |
| [ ] | 2.3 删除mock数据文件 | `src/mock/data.ts` |
| [ ] | 2.4 清理所有引用mock数据的代码 | stores、views等 |
| [ ] | 2.5 更新API接口定义，对接真实后端接口 | `src/api/` |
| [ ] | 2.6 测试API连通性 | - |

---

## 三、完善项目初始化流程

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 3.1 完善应用启动逻辑 | `src/main.ts` |
| [ ] | 3.2 优化路由守卫 | `src/router/guards.ts` |
| [ ] | 3.3 完善认证状态初始化 | `src/stores/auth/index.ts` |
| [ ] | 3.4 完善权限状态初始化 | `src/stores/permission/index.ts` |
| [ ] | 3.5 完善项目状态初始化 | `src/stores/project/index.ts` |
| [ ] | 3.6 实现token刷新机制 | `src/api/request.ts` |
| [ ] | 3.7 实现登录状态持久化恢复 | `src/stores/auth/index.ts` |

---

## 四、用户创建功能

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 4.1 完善用户相关API（CRUD） | `src/api/system/index.ts` |
| [ ] | 4.2 完善用户列表页面 | `src/views/System/User.vue` |
| [ ] | 4.3 实现用户创建表单 | `src/views/System/User.vue` |
| [ ] | 4.4 实现用户编辑功能 | `src/views/System/User.vue` |
| [ ] | 4.5 实现用户删除功能 | `src/views/System/User.vue` |
| [ ] | 4.6 实现用户状态启用/禁用 | `src/views/System/User.vue` |
| [ ] | 4.7 实现用户搜索和分页 | `src/views/System/User.vue` |

---

## 五、角色创建功能

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 5.1 完善角色相关API（CRUD） | `src/api/project/index.ts` |
| [ ] | 5.2 完善角色列表页面 | `src/views/Project/Role.vue` |
| [ ] | 5.3 实现角色创建表单 | `src/views/Project/Role.vue` |
| [ ] | 5.4 实现角色编辑功能 | `src/views/Project/Role.vue` |
| [ ] | 5.5 实现角色删除功能 | `src/views/Project/Role.vue` |
| [ ] | 5.6 实现角色菜单分配 | `src/views/Project/Role.vue` |
| [ ] | 5.7 实现角色成员查看 | `src/views/Project/Role.vue` |

---

## 六、权限管理功能

### 说明

权限（sys_permission）是**操作权限**，控制用户能执行哪些API操作。

**与菜单权限的区别**：
- **菜单权限**：控制用户能看到哪些页面
- **操作权限**：控制用户能执行哪些操作（如创建、删除、编辑）

**鉴权方式**：后端 API 层面鉴权，前端不做按钮级控制

### 子任务清单

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 6.1 完善权限相关API | `src/api/project/index.ts` |
| [ ] | 6.2 完善权限配置页面 | `src/views/Project/Permission.vue` |
| [ ] | 6.3 实现权限创建功能 | `src/views/Project/Permission.vue` |
| [ ] | 6.4 实现权限编辑功能 | `src/views/Project/Permission.vue` |
| [ ] | 6.5 实现权限删除功能 | `src/views/Project/Permission.vue` |
| [ ] | 6.6 实现角色权限分配 | `src/views/Project/Role.vue` |

### 权限编码规范

建议采用 `模块:操作` 格式：

| permission_code | permission_name | 说明 |
|-----------------|-----------------|------|
| user:create | 创建用户 | 创建新用户 |
| user:edit | 编辑用户 | 修改用户信息 |
| user:delete | 删除用户 | 删除用户 |
| user:view | 查看用户 | 查看用户列表/详情 |
| role:create | 创建角色 | 创建新角色 |
| role:edit | 编辑角色 | 修改角色信息 |
| role:delete | 删除角色 | 删除角色 |
| role:assign | 分配角色 | 给用户分配角色 |

### 后端鉴权示例

```java
// 注解方式
@RequirePermission("user:create")
@PostMapping("/users")
public Result createUser(@RequestBody UserDTO dto) { ... }

// 拦截器方式
public class PermissionInterceptor {
    public boolean preHandle(HttpServletRequest request, ...) {
        String permission = getRequiredPermission(request);
        List<String> userPermissions = getUserPermissions(request);
        if (!userPermissions.contains(permission)) {
            throw new ForbiddenException("无操作权限");
        }
        return true;
    }
}
```

---

## 七、groupCode菜单调整

| 状态 | 子任务 | 相关文件 |
|------|--------|----------|
| [ ] | 7.1 移除 'log' 分组 | `src/config/menus.ts` |
| [ ] | 7.2 移除 'console' 分组 | `src/config/menus.ts` |
| [ ] | 7.3 删除或注释日志相关页面 | `src/views/Log/` |
| [ ] | 7.4 更新路由配置 | `src/router/index.ts` |
| [ ] | 7.5 更新侧边栏菜单渲染逻辑 | `src/components/Layout/AppSidebar.vue` |
| [ ] | 7.6 清理相关类型定义 | `src/types/menu.ts` |

---

## 建议执行顺序

```
第零阶段：数据库设计（✅ 已完成）
└── 任务零：数据库表结构设计

第一阶段：菜单基础
└── 任务一：菜单同步功能开发

第二阶段：基础设施
├── 任务二：接入后端API，删除测试数据
└── 任务三：完善项目初始化流程

第三阶段：核心功能
├── 任务四：用户创建
├── 任务五：角色创建
└── 任务六：权限管理

第四阶段：优化调整
└── 任务七：groupCode菜单调整
```

---

## 待确认事项

- [x] 超管和普通用户的访问规则（已明确）
- [x] 普通用户无项目时的处理（已明确：空布局+提示）
- [x] 角色是项目级的（已明确）
- [x] 菜单同步方案（已明确：同步API）
- [x] 数据库表结构设计（已完成）
- [x] 权限鉴权方式（已明确：后端API层面鉴权）
- [ ] 后端API地址（当前配置：`http://localhost:8080`）
- [ ] 后端API文档（Swagger或其他）

---

## 更新记录

| 日期 | 更新内容 |
|------|----------|
| 2025-12-24 | 创建任务计划文档 |
| 2025-12-25 | 数据库表结构设计完成（12张表） |
| 2025-12-25 | 更新任务状态，添加权限管理说明 |
