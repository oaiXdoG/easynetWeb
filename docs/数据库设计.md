# 数据库设计文档

## 系统定位

**公司内部后台管理系统（私有化部署）**

- 每个公司独立部署、独立数据库
- 一个公司可以创建多个项目
- 用户可以属于多个项目，每个项目下有不同角色
- 菜单和菜单分组是全局的（平台级）
- 权限是项目级的

---

## 设计原则

### 核心原则

1. **前端为主，后端映射**
   - 前端 `config/menus.ts` 是菜单配置的唯一数据源
   - 后端数据库存储平台菜单数据，映射前端配置
   - 通过"同步菜单"API 保持前后端数据一致

2. **分组和菜单分离**
   - `sys_menu_group`：存储菜单分组（全局）
   - `sys_menu`：存储具体菜单项（全局）
   - 两张表都是平台数据，不包含 `project_id`

3. **关系表管理权限**
   - `sys_project_menu`：项目启用了哪些菜单
   - `sys_role_menu_group`：角色可以看哪些菜单分组（必须先分配）
   - `sys_role_menu`：角色可以看哪些菜单（必须属于已分配的分组）
   - `sys_role_permission`：角色拥有哪些操作权限

4. **权限后端鉴权**
   - 前端不做按钮级权限控制
   - 后端 API 层面进行权限校验

---

## 表结构总览（12张表）

| 序号 | 表名 | 说明 | 级别 |
|------|------|------|------|
| 1 | sys_user | 用户表 | 全局 |
| 2 | sys_project | 项目表 | 全局 |
| 3 | sys_role | 角色表 | 项目级 |
| 4 | sys_user_project | 用户-项目-角色关系表 | 关系 |
| 5 | sys_menu_group | 菜单分组表 | 全局 |
| 6 | sys_menu | 菜单表 | 全局 |
| 7 | sys_project_menu | 项目启用菜单表 | 关系 |
| 8 | sys_role_menu_group | 角色-菜单分组关系表 | 关系 |
| 9 | sys_role_menu | 角色-菜单关系表 | 关系 |
| 10 | sys_permission | 操作权限表 | 项目级 |
| 11 | sys_role_permission | 角色-权限关系表 | 关系 |
| 12 | sys_operation_log | 操作日志表 | 全局 |

---

## 关系结构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户与项目关系层                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   sys_user ──────────┬───────────────── sys_user_project                │
│   (用户表)            │                  (用户-项目-角色关系)             │
│   ├─ id              │                  ├─ user_id ───────┘             │
│   ├─ username        │                  ├─ project_id ────┐             │
│   ├─ is_super_admin  │                  ├─ role_id ───────│─────┐       │
│   └─ status          │                  └─ UNIQUE(user,proj)    │       │
│                      │                                          │       │
│   sys_project ───────┴──────────────────────────────────────────│       │
│   (项目表)                                                       │       │
│   ├─ id                                                         │       │
│   ├─ project_name                                               │       │
│   ├─ owner_id (拥有者)                                          │       │
│   └─ status                                                     │       │
│                                                                  │       │
└──────────────────────────────────────────────────────────────────│───────┘
                                                                   │
┌──────────────────────────────────────────────────────────────────│───────┐
│                          角色与权限层                             │       │
├──────────────────────────────────────────────────────────────────│───────┤
│                                                                   │       │
│   sys_role ◀─────────────────────────────────────────────────────┘       │
│   (角色表 - 项目级)                                                       │
│   ├─ id                                                                  │
│   ├─ project_id                                                          │
│   ├─ role_name                                                           │
│   └─ status                                                              │
│        │                                                                 │
│        ├─────────────▶ sys_role_menu_group (必须先分配分组)              │
│        ├─────────────▶ sys_role_menu (然后才能分配菜单)                  │
│        └─────────────▶ sys_role_permission (分配操作权限)                │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                          菜单与权限定义层                                 │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   sys_menu_group (全局)          sys_permission (项目级)                 │
│   ├─ group_code                  ├─ project_id                           │
│   └─ group_title                 ├─ permission_code                      │
│        │                         └─ permission_name                      │
│        └──▶ sys_menu (全局)                                              │
│             ├─ group_id                                                  │
│             ├─ parent_id (扩展)                                          │
│             ├─ menu_code                                                 │
│             └─ menu_name                                                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                          项目菜单配置层                                   │
├──────────────────────────────────────────────────────────────────────────┤
│   sys_project_menu (项目启用哪些菜单)                                    │
│   ├─ project_id ──────▶ sys_project                                      │
│   └─ menu_id ─────────▶ sys_menu                                         │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                          日志审计层                                       │
├──────────────────────────────────────────────────────────────────────────┤
│   sys_operation_log (操作日志)                                           │
│   ├─ user_id, project_id                                                 │
│   └─ 请求信息、响应信息、IP等                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 核心表详细设计

### 1. sys_user（用户表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| username | VARCHAR(50) | 用户名（唯一） |
| password | VARCHAR(255) | 密码 |
| email | VARCHAR(100) | 邮箱 |
| phone | VARCHAR(20) | 手机号 |
| real_name | VARCHAR(50) | 真实姓名 |
| avatar | VARCHAR(255) | 头像URL |
| is_super_admin | TINYINT | 是否超级管理员：0-否，1-是 |
| status | TINYINT | 状态：0-禁用，1-正常 |
| last_login_at | DATETIME | 最后登录时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2. sys_project（项目表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| project_name | VARCHAR(100) | 项目名称 |
| description | VARCHAR(500) | 项目描述 |
| owner_id | BIGINT UNSIGNED | 项目所有者ID |
| status | TINYINT | 状态：0-停用，1-正常 |
| created_by | BIGINT UNSIGNED | 创建人ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 3. sys_role（角色表 - 项目级）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| project_id | BIGINT UNSIGNED | 项目ID |
| role_name | VARCHAR(50) | 角色名称 |
| description | VARCHAR(255) | 角色描述 |
| status | TINYINT | 状态：0-禁用，1-正常 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**说明**：角色属于项目，不能跨项目使用。

---

### 4. sys_user_project（用户-项目-角色关系表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| user_id | BIGINT UNSIGNED | 用户ID |
| project_id | BIGINT UNSIGNED | 项目ID |
| role_id | BIGINT UNSIGNED | 角色ID |
| status | TINYINT | 状态：0-禁用，1-正常 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**约束**：`UNIQUE (user_id, project_id)` - 一个用户在一个项目只能有一个角色

---

### 5. sys_menu_group（菜单分组表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| group_code | VARCHAR(50) | 分组编码（唯一） |
| group_title | VARCHAR(100) | 分组名称 |
| sort_order | INT | 排序号 |
| status | TINYINT | 状态：0-禁用，1-正常 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**数据示例**：

| group_code | group_title | sort_order |
|------------|-------------|------------|
| console | 控制台 | 1 |
| log | 日志 | 2 |
| project_settings | 项目设置 | 3 |
| system | 系统管理 | 100 |

---

### 6. sys_menu（菜单表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| group_id | BIGINT UNSIGNED | 分组ID |
| parent_id | BIGINT UNSIGNED | 父菜单ID（预留扩展，NULL表示顶级） |
| menu_code | VARCHAR(50) | 菜单编码（唯一） |
| menu_name | VARCHAR(100) | 菜单名称 |
| menu_type | TINYINT | 菜单类型：1-目录，2-菜单，3-按钮 |
| icon | VARCHAR(100) | 菜单图标 |
| path | VARCHAR(255) | 路由路径 |
| component | VARCHAR(255) | 组件路径 |
| is_hidden | TINYINT | 是否隐藏：0-否，1-是 |
| sort_order | INT | 排序号 |
| status | TINYINT | 状态：0-禁用，1-正常 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**说明**：
- 当前设计为"分组→菜单"两级结构
- `parent_id` 字段预留，用于后续扩展多级菜单

---

### 7. sys_project_menu（项目启用菜单表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| project_id | BIGINT UNSIGNED | 项目ID |
| menu_id | BIGINT UNSIGNED | 菜单ID |
| created_at | DATETIME | 创建时间 |

**约束**：`UNIQUE (project_id, menu_id)`

**业务说明**：
- 创建项目时，超管从 sys_menu 中选择菜单
- 只存储 menu_id，分组通过 sys_menu.group_id 推导

---

### 8. sys_role_menu_group（角色-菜单分组关系表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| role_id | BIGINT UNSIGNED | 角色ID |
| menu_group_id | BIGINT UNSIGNED | 菜单分组ID |
| created_at | DATETIME | 创建时间 |

**约束**：`UNIQUE (role_id, menu_group_id)`

**业务说明**：必须先给角色分配菜单分组，才能分配该分组下的菜单

---

### 9. sys_role_menu（角色-菜单关系表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| role_id | BIGINT UNSIGNED | 角色ID |
| menu_id | BIGINT UNSIGNED | 菜单ID |
| created_at | DATETIME | 创建时间 |

**约束**：`UNIQUE (role_id, menu_id)`

**业务规则**：
- 角色的菜单必须属于已分配的分组
- 角色的菜单必须是项目菜单的子集

---

### 10. sys_permission（操作权限表 - 项目级）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| project_id | BIGINT UNSIGNED | 项目ID |
| permission_code | VARCHAR(100) | 权限编码 |
| permission_name | VARCHAR(100) | 权限名称 |
| description | VARCHAR(255) | 权限描述 |
| status | TINYINT | 状态：0-禁用，1-正常 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**约束**：`UNIQUE (project_id, permission_code)`

**说明**：权限是项目级的，不同项目可以有不同的权限定义

---

### 11. sys_role_permission（角色-权限关系表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| role_id | BIGINT UNSIGNED | 角色ID |
| permission_id | BIGINT UNSIGNED | 权限ID |
| created_at | DATETIME | 创建时间 |

**约束**：`UNIQUE (role_id, permission_id)`

---

### 12. sys_operation_log（操作日志表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| user_id | BIGINT UNSIGNED | 用户ID |
| project_id | BIGINT UNSIGNED | 项目ID |
| module | VARCHAR(50) | 模块名称 |
| action | VARCHAR(50) | 操作动作 |
| description | VARCHAR(500) | 操作描述 |
| request_method | VARCHAR(10) | 请求方法 |
| request_url | VARCHAR(255) | 请求URL |
| request_params | TEXT | 请求参数 |
| response_code | INT | 响应状态码 |
| ip | VARCHAR(50) | IP地址 |
| user_agent | VARCHAR(500) | 用户代理 |
| execution_time | INT | 执行时长(ms) |
| created_at | DATETIME | 创建时间 |

---

## 权限层级设计

```
平台菜单（sys_menu）
    ⊇
项目菜单（sys_project_menu）
    ⊇
角色菜单分组（sys_role_menu_group）
    ⊇
角色菜单（sys_role_menu）
    ⊇
用户可见菜单（用户角色的菜单）
```

### 业务规则

1. **创建项目时**：
   - 超管从 `sys_menu` 中选择菜单
   - 插入 `sys_project_menu` 表

2. **创建角色时**：
   - 项目管理员先选择菜单分组 → 插入 `sys_role_menu_group`
   - 然后选择该分组下的菜单 → 插入 `sys_role_menu`
   - 菜单必须是项目菜单的子集

3. **用户登录时**：
   - 查询用户在当前项目的角色
   - 查询该角色的所有菜单
   - 返回 `visibleMenuCodes` 给前端

4. **API 权限校验**：
   - 后端通过 `sys_role_permission` 判断用户是否有操作权限
   - 无权限返回 403

---

## 常见查询示例

### 查询项目的所有菜单（含分组）

```sql
SELECT
  g.group_code,
  g.group_title,
  m.menu_code,
  m.menu_name,
  m.icon,
  m.path
FROM sys_project_menu pm
JOIN sys_menu m ON pm.menu_id = m.id
JOIN sys_menu_group g ON m.group_id = g.id
WHERE pm.project_id = 1
ORDER BY g.sort_order, m.sort_order;
```

### 查询角色的所有菜单

```sql
SELECT
  m.menu_code,
  m.menu_name
FROM sys_role_menu rm
JOIN sys_menu m ON rm.menu_id = m.id
WHERE rm.role_id = 1
ORDER BY m.sort_order;
```

### 查询用户在当前项目的可见菜单

```sql
SELECT DISTINCT m.menu_code
FROM sys_user_project up
JOIN sys_role_menu rm ON up.role_id = rm.role_id
JOIN sys_menu m ON rm.menu_id = m.id
WHERE up.user_id = 1
  AND up.project_id = 1
  AND up.status = 1;
```

### 查询用户在当前项目的权限列表

```sql
SELECT DISTINCT p.permission_code
FROM sys_user_project up
JOIN sys_role_permission rp ON up.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.id
WHERE up.user_id = 1
  AND up.project_id = 1
  AND up.status = 1
  AND p.status = 1;
```

---

## 文件位置

- **建表SQL**：`database/schema-optimized.sql`
- **本文档**：`docs/数据库设计.md`

---

## 更新记录

| 日期 | 更新内容 |
|------|----------|
| 2025-12-24 | 创建文档 |
| 2025-12-25 | 更新表结构，添加 status/created_at/updated_at 等字段 |
| 2025-12-25 | 删除 role_code、project_code 等冗余字段 |
| 2025-12-25 | 完善权限层级设计和查询示例 |
