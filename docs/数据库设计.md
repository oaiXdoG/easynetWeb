# 数据库设计文档（新版）

## 设计原则

### 核心原则

1. **前端为主，后端映射**
   - 前端 `config/menus.ts` 是菜单配置的唯一数据源
   - 后端数据库存储平台菜单数据，映射前端配置
   - 通过"同步菜单"API 保持前后端数据一致

2. **分组和菜单分离**
   - `sys_menu_group`：存储菜单分组（console、log、project_settings、system）
   - `sys_menu`：存储具体菜单项（dashboard、log_app、project_member...）
   - 两张表都是纯平台数据，不包含 `project_id`

3. **关系表管理权限**
   - `sys_project_menu`：项目启用了哪些菜单（只存 menu_id）
   - `sys_role_menu`：角色可以看哪些菜单（只存 menu_id）
   - 分组通过菜单的 `group_id` 自动推导

---

## 表结构总览

| 序号 | 表名 | 说明 | 记录数参考 |
|------|------|------|------------|
| 1 | sys_menu_group | 菜单分组表 | 4条（console、log、project_settings、system） |
| 2 | sys_menu | 菜单表 | 8条（dashboard、log_app、log_server...） |
| 3 | sys_user | 用户表 | 动态 |
| 4 | sys_project | 项目表 | 动态 |
| 5 | sys_role | 角色表（项目级） | 动态 |
| 6 | sys_permission | 权限表 | 动态 |
| 7 | sys_user_tag | 用户标签表 | 动态 |
| 8 | sys_operation_log | 操作日志表 | 动态 |
| 9 | sys_user_project | 用户-项目关系表 | 动态 |
| 10 | sys_user_project_role | 用户-项目-角色关系表 | 动态 |
| 11 | sys_role_permission | 角色-权限关系表 | 动态 |
| 12 | sys_user_tag_relation | 用户-标签关系表 | 动态 |
| 13 | sys_project_menu | 项目-菜单关系表 | 动态 |
| 14 | sys_role_menu | 角色-菜单关系表 | 动态 |

---

## 核心表详细设计

### 1. sys_menu_group（菜单分组表）

**用途**：存储所有菜单分组，对应前端 `config/menus.ts` 中的 `PlatformMenuGroup`

**字段：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| group_code | VARCHAR(50) | 分组编码（唯一，对应前端 groupCode） |
| group_title | VARCHAR(100) | 分组标题 |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**数据示例：**

| id | group_code | group_title | sort_order |
|----|------------|-------------|------------|
| 1 | console | 控制台 | 1 |
| 2 | log | 日志 | 2 |
| 3 | project_settings | 项目设置 | 3 |
| 100 | system | 系统管理 | 100 |

---

### 2. sys_menu（菜单表）

**用途**：存储所有菜单项，对应前端 `config/menus.ts` 中的 `PlatformMenuItem`

**字段：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| group_id | BIGINT UNSIGNED | 所属分组ID（外键 sys_menu_group.id） |
| menu_code | VARCHAR(50) | 菜单编码（唯一，对应前端 menuCode） |
| menu_name | VARCHAR(100) | 菜单名称 |
| icon | VARCHAR(100) | Material Icons 图标名 |
| path | VARCHAR(255) | 路由路径 |
| component | VARCHAR(255) | 组件路径（相对于 views 目录） |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**数据示例：**

| id | group_id | menu_code | menu_name | icon | path | component | sort_order |
|----|----------|-----------|-----------|------|------|-----------|------------|
| 1 | 1 | dashboard | 数据看板 | dashboard | /console/dashboard | Dashboard/Index.vue | 1 |
| 2 | 2 | log_app | 应用日志 | receipt_long | /log/app | Log/Game.vue | 1 |
| 4 | 3 | project_member | 成员管理 | people | /project/member | Project/Member.vue | 1 |
| 101 | 100 | system_user | 账号管理 | person | /system/user | System/User.vue | 1 |

---

### 3. sys_project_menu（项目-菜单关系表）

**用途**：存储项目启用了哪些菜单

**字段：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| project_id | BIGINT UNSIGNED | 项目ID |
| menu_id | BIGINT UNSIGNED | 菜单ID（指向 sys_menu.id） |
| created_at | DATETIME | 创建时间 |

**约束：**
- UNIQUE (project_id, menu_id)

**业务说明：**
- 创建项目时，超管从 sys_menu 中选择菜单
- 只存储 menu_id，不存储 group_id
- 分组通过 `sys_menu.group_id` 自动推导

**数据示例：**

| id | project_id | menu_id | 说明 |
|----|------------|---------|------|
| 1 | 1 | 1 | 项目1启用了"数据看板" |
| 2 | 1 | 2 | 项目1启用了"应用日志" |
| 3 | 1 | 4 | 项目1启用了"成员管理" |

---

### 4. sys_role_menu（角色-菜单关系表）

**用途**：存储角色可以看哪些菜单

**字段：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT UNSIGNED | 主键 |
| role_id | BIGINT UNSIGNED | 角色ID |
| menu_id | BIGINT UNSIGNED | 菜单ID（指向 sys_menu.id） |
| created_at | DATETIME | 创建时间 |

**约束：**
- UNIQUE (role_id, menu_id)

**业务说明：**
- 创建角色时，项目管理员从项目的菜单中选择（`sys_project_menu`）
- 角色的菜单必须是项目菜单的子集
- 只存储 menu_id，不存储 group_id

**数据示例：**

| id | role_id | menu_id | 说明 |
|----|---------|---------|------|
| 1 | 1 | 1 | 角色1可以看"数据看板" |
| 2 | 1 | 2 | 角色1可以看"应用日志" |

---

## 权限层级设计

```
平台菜单（sys_menu）
    ⊇
项目菜单（sys_project_menu）
    ⊇
角色菜单（sys_role_menu）
    ⊇
用户可见菜单（用户在当前项目的所有角色菜单的并集）
```

### 业务规则

1. **创建项目时**：
   - 超管从 `sys_menu` 中选择菜单
   - 插入 `sys_project_menu` 表

2. **创建角色时**：
   - 项目管理员从当前项目的菜单中选择（查询 `sys_project_menu`）
   - 插入 `sys_role_menu` 表
   - 必须满足：`sys_role_menu.menu_id IN (SELECT menu_id FROM sys_project_menu WHERE project_id = 当前项目)`

3. **用户登录时**：
   - 查询用户在当前项目的所有角色
   - 查询这些角色的所有菜单（并集）
   - 返回 `visibleMenuCodes` 给前端
   - 前端根据 `menuCode` 过滤 `config/menus.ts` 中的菜单

---

## 菜单同步机制

### 同步流程

```
1. 超管在项目管理页面点击"同步菜单"按钮
        ↓
2. 前端读取 config/menus.ts 的 platformMenus 和 superAdminMenus
        ↓
3. 格式化数据，POST /api/admin/sync-menus
        ↓
4. 后端对比数据库 sys_menu_group 和 sys_menu
        ↓
5. 执行增删改操作（事务）
        ↓
6. 返回同步结果（新增、更新、删除数量）
```

### API 设计

**接口**：`POST /api/admin/sync-menus`

**权限**：仅超级管理员可调用

**请求参数**：
```typescript
interface SyncMenusRequest {
  groups: Array<{
    groupCode: string
    groupTitle: string
    sortOrder: number
  }>
  menus: Array<{
    groupCode: string      // 所属分组
    menuCode: string
    menuName: string
    icon: string
    path: string
    component: string
    sortOrder: number
  }>
}
```

**响应**：
```typescript
interface SyncMenusResponse {
  success: boolean
  message: string
  data: {
    groups: {
      added: number
      updated: number
      deleted: number
    }
    menus: {
      added: number
      updated: number
      deleted: number
    }
    total: {
      groups: number
      menus: number
    }
  }
}
```

### 后端同步逻辑

1. **验证权限**：确保调用者是超级管理员
2. **同步分组**：
   - 对比 `sys_menu_group` 表
   - 新增：前端有，数据库没有 → INSERT
   - 更新：都有但内容不同 → UPDATE
   - 删除：数据库有，前端没有 → 检查是否被使用，然后 DELETE
3. **同步菜单**：
   - 对比 `sys_menu` 表
   - 新增/更新/删除逻辑同上
   - 需要通过 `groupCode` 找到 `group_id`
4. **事务执行**：所有变更在一个事务中完成
5. **返回结果**：统计变更数量

---

## 与旧设计的对比

| 项目 | 旧设计 | 新设计 |
|------|--------|--------|
| 菜单表 | sys_menu（包含 project_id） | sys_menu_group + sys_menu（不包含 project_id） |
| 项目菜单 | sys_menu where project_id = X | sys_project_menu 关系表 |
| 角色菜单 | sys_menu_permission | sys_role_menu 关系表 |
| 分组设计 | parent_id 区分 | 独立的 sys_menu_group 表 |
| 数据源 | 不明确 | 前端 config/menus.ts 为唯一数据源 |

---

## 初始化步骤

1. **创建表结构**：
   ```bash
   mysql -u root -p database_name < database/schema-new.sql
   ```

2. **初始化菜单数据**：
   ```bash
   mysql -u root -p database_name < database/seed-menus.sql
   ```

3. **验证数据**：
   ```sql
   SELECT * FROM sys_menu_group;
   SELECT * FROM sys_menu;
   ```

---

## 数据完整性约束

### 外键关系（推荐在应用层维护）

- `sys_menu.group_id` → `sys_menu_group.id`
- `sys_project_menu.menu_id` → `sys_menu.id`
- `sys_role_menu.menu_id` → `sys_menu.id`

### 唯一约束

- `sys_menu_group.group_code` UNIQUE
- `sys_menu.menu_code` UNIQUE
- `sys_project_menu(project_id, menu_id)` UNIQUE
- `sys_role_menu(role_id, menu_id)` UNIQUE

---

## 常见查询示例

### 查询项目的所有菜单（含分组）

```sql
SELECT
  g.group_code,
  g.group_title,
  m.menu_code,
  m.menu_name,
  m.icon,
  m.path
FROM sys_project_menu pm
JOIN sys_menu m ON pm.menu_id = m.id
JOIN sys_menu_group g ON m.group_id = g.id
WHERE pm.project_id = 1
ORDER BY g.sort_order, m.sort_order;
```

### 查询角色的所有菜单

```sql
SELECT
  m.menu_code,
  m.menu_name
FROM sys_role_menu rm
JOIN sys_menu m ON rm.menu_id = m.id
WHERE rm.role_id = 1
ORDER BY m.sort_order;
```

### 查询用户在当前项目的可见菜单

```sql
SELECT DISTINCT m.menu_code
FROM sys_user_project_role upr
JOIN sys_role_menu rm ON upr.role_id = rm.role_id
JOIN sys_menu m ON rm.menu_id = m.id
WHERE upr.user_id = 1
  AND upr.project_id = 1;
```

---

## 文件位置

- **建表SQL**：`database/schema-new.sql`
- **初始化数据SQL**：`database/seed-menus.sql`
- **本文档**：`docs/数据库设计.md`
