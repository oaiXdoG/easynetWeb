# EasynetWeb 架构设计文档

## 一、系统定位

**公司内部后台管理系统（私有化部署）**

- 每个公司独立部署、独立数据库
- 支持多项目管理
- 基于角色的权限控制

---

## 二、用户角色

| 角色 | 说明 | 权限范围 |
|------|------|----------|
| 超级管理员 | `is_super_admin = 1` | 管理所有用户和项目，不属于任何项目 |
| 普通用户 | `is_super_admin = 0` | 属于一个或多个项目，每个项目有一个角色 |

### 超级管理员
- 管理用户（CRUD）
- 管理项目（CRUD）
- 配置项目菜单
- 同步菜单数据
- **不进入任何项目**

### 普通用户
- 属于一个或多个项目
- 在每个项目中有一个角色
- 根据角色看到不同的菜单
- 根据角色拥有不同的操作权限

---

## 三、数据库设计

### 表结构（11张表）

| 序号 | 表名 | 说明 | 级别 |
|------|------|------|------|
| 1 | sys_user | 用户表 | 全局 |
| 2 | sys_project | 项目表 | 全局 |
| 3 | sys_role | 角色表 | 项目级 |
| 4 | sys_user_project | 用户-项目-角色关系 | 关系 |
| 5 | sys_menu_group | 菜单分组表 | 全局 |
| 6 | sys_menu | 菜单表 | 全局 |
| 7 | sys_project_menu | 项目启用菜单 | 关系 |
| 8 | sys_role_menu | 角色-菜单 | 关系 |
| 9 | sys_permission | 操作权限表 | 项目级 |
| 10 | sys_role_permission | 角色-权限 | 关系 |
| 11 | sys_operation_log | 操作日志 | 全局 |

### 核心关系

```
用户(sys_user)
  │
  ├── 超管：is_super_admin = 1，不属于任何项目
  │
  └── 普通用户：通过 sys_user_project 关联项目和角色
        │
        └── sys_user_project (user_id, project_id, role_id)
              │
              └── 一个用户在一个项目只能有一个角色（UNIQUE约束）


项目(sys_project)
  │
  └── sys_project_menu → 项目启用了哪些菜单


角色(sys_role) - 项目级
  │
  ├── sys_role_menu → 角色可访问的菜单
  └── sys_role_permission → 角色拥有的操作权限


菜单(sys_menu + sys_menu_group) - 全局
  │
  └── 分组 → 菜单（两级结构，parent_id 预留扩展）


权限(sys_permission) - 项目级
  │
  └── 操作权限，用于后端API鉴权（如 user:create, user:delete）
```

### 权限层级

```
平台全量菜单 (sys_menu)
    ⊇
项目启用菜单 (sys_project_menu)
    ⊇
角色菜单 (sys_role_menu)
    ⊇
用户可见菜单
```

---

## 四、认证机制

### 登录流程

```
1. 用户输入用户名密码
      ↓
2. POST /api/auth/login
      ↓
3. 后端验证，生成 Token
      ↓
4. 返回 Token + 用户信息（含 is_super_admin）
      ↓
5. 前端存储 Token，跳转到对应页面
      ↓
6. 超管 → 系统管理页面
   普通用户 → 项目选择/默认项目
```

### Token 机制

- 登录成功返回 Token
- 前端存储在 localStorage
- 每次请求携带 `Authorization: Bearer <token>`
- 后端验证 Token 有效性

---

## 五、前端路由设计

### 超管路由

```
/login          → 登录页
/system         → 系统管理（超管专属）
  /system/user     → 账号管理
  /system/project  → 项目管理
```

### 普通用户路由

```
/login          → 登录页
/select-project → 项目选择页（多项目时）
/:projectId     → 项目工作台
  /console/dashboard    → 数据看板
  /log/app              → 应用日志
  /project/member       → 成员管理
  /project/role         → 角色管理
  /project/permission   → 权限配置
```

### 路由守卫逻辑

```
1. 检查是否有 Token
   ├── 无 Token → 跳转登录页
   └── 有 Token → 继续

2. 获取用户信息
   ├── 超管 → 只能访问 /system/*
   └── 普通用户 → 只能访问项目相关路由

3. 普通用户检查
   ├── 无项目 → 显示空页面提示
   └── 有项目 → 加载项目菜单
```

---

## 六、菜单机制

### 数据源

前端 `src/config/menus.ts` 是菜单配置的唯一数据源

### 同步机制

超管通过"同步菜单"功能，将前端菜单配置同步到数据库：
- `sys_menu_group` - 菜单分组
- `sys_menu` - 菜单项

### 菜单分配流程

```
1. 超管同步菜单 → 数据库有了所有菜单数据
      ↓
2. 超管创建项目 → 选择该项目启用哪些菜单 → sys_project_menu
      ↓
3. 项目管理员创建角色 → 选择角色可访问的菜单 → sys_role_menu_group + sys_role_menu
      ↓
4. 用户登录 → 根据角色获取可见菜单 → 前端渲染侧边栏
```

---

## 七、权限鉴权

### 两种权限

| 类型 | 表 | 控制 | 鉴权位置 |
|------|-----|------|----------|
| 菜单权限 | sys_role_menu | 用户能看到哪些页面 | 前端渲染 |
| 操作权限 | sys_role_permission | 用户能执行哪些操作 | 后端API |

### 操作权限编码规范

```
模块:操作

示例：
- user:create   创建用户
- user:edit     编辑用户
- user:delete   删除用户
- role:assign   分配角色
```

### 后端鉴权

- 每个需要权限控制的 API 标注所需权限
- 请求时验证用户是否拥有该权限
- 无权限返回 403

---

## 八、API 设计规范

### 基础结构

**请求头：**
```
Authorization: Bearer <token>
Content-Type: application/json
```

**响应结构：**
```java
public class ApiResponse<T> {
    private Integer code;      // 状态码：200成功，其他失败
    private String message;    // 提示信息
    private T data;            // 数据
}
```

### API 分组

| 模块 | 前缀 | 说明 |
|------|------|------|
| 认证 | /api/auth | 登录、登出、刷新Token |
| 用户 | /api/users | 用户CRUD（超管） |
| 项目 | /api/projects | 项目CRUD（超管） |
| 角色 | /api/projects/{id}/roles | 角色CRUD（项目级） |
| 权限 | /api/projects/{id}/permissions | 权限CRUD（项目级） |
| 菜单 | /api/admin/menus | 菜单同步（超管） |

---

## 九、文件结构

### 数据库文件

```
database/
├── schema.sql       # 表结构（12张表）
└── seed-menus.sql   # 菜单初始化数据
```

### 文档

```
docs/
├── 架构设计.md      # 本文档
└── 开发计划.md      # 开发任务进度
```
