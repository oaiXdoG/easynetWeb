# 菜单权限设计文档

## 系统定位

**公司内部后台管理系统（私有化部署）**

- 每个公司独立部署、独立数据库
- 不是多租户 SaaS，不需要租户表

---

## 设计理念

**前端为主 + 后端同步平台菜单 + 权限后端鉴权**

- 前端：完全控制菜单定义（名称、图标、路径）- `src/config/menus.ts`
- 后端：存储平台菜单模板和权限关系
- 超管可通过"同步菜单"API 将前端配置同步到后端数据库
- 操作权限在后端 API 层面鉴权，前端不做按钮级控制

---

## 用户类型和访问规则

### 超级管理员（is_super_admin = 1）

**特点：**
- ✅ 只在平台层管理，不进入任何项目
- ✅ 管理项目生命周期（增删改查、启用/禁用）
- ✅ 配置项目的菜单权限（项目可以使用哪些菜单）
- ✅ 管理账号生命周期（增删改查、启用/禁用）
- ✅ 分配账号到项目、移除账号
- ❌ 不属于任何项目（sys_user_project 表中无记录）

**登录后体验：**
```
登录 → 直接进入平台管理界面
         ├─ 系统管理
         │   ├─ 账号管理 (system_user)
         │   └─ 项目管理 (system_project)
         └─ （无项目切换功能）
```

---

### 普通用户（is_super_admin = 0）

**有项目时：**
```
登录 → 选择项目（或默认项目）→ 进入项目工作台
                                  ├─ 控制台 (dashboard)
                                  ├─ 日志 (log_app, log_server)
                                  └─ 项目设置 (member, role, permission)
```

- ✅ 可以属于多个项目
- ✅ 在每个项目下有一个角色（一个用户在一个项目只能有一个角色）
- ✅ 根据项目内角色看到不同菜单
- ❌ 看不到"系统管理"菜单

**无项目时：**
```
登录 → 空布局 + 提示"还未加入项目"
       （无任何操作按钮）
```

---

## 权限层级

```
平台全量菜单（sys_menu - 前端代码定义 + 同步到数据库）
    ⊇
项目可用菜单（sys_project_menu - 超管创建项目时配置）
    ⊇
角色可用菜单分组（sys_role_menu_group - 必须先分配分组）
    ⊇
角色可用菜单（sys_role_menu - 然后才能分配菜单）
    ⊇
用户可见菜单（用户在当前项目的角色菜单）
```

---

## 两种权限的区别

### 菜单权限 vs 操作权限

| 维度 | 菜单权限 | 操作权限 |
|------|----------|----------|
| **表** | sys_menu / sys_role_menu | sys_permission / sys_role_permission |
| **控制什么** | 用户能看到哪些**页面** | 用户能执行哪些**操作** |
| **举例** | 能看到"用户管理"页面 | 能执行"创建用户"、"删除用户" |
| **级别** | 全局（平台级） | 项目级 |
| **鉴权位置** | 前端渲染时过滤 | 后端 API 层面 |

### 操作权限使用场景

```
用户进入"用户管理"页面（菜单权限 ✅）
  ├── 点击"新增"按钮 → POST /api/users → 后端检查 user:create 权限
  ├── 点击"编辑"按钮 → PUT /api/users/:id → 后端检查 user:edit 权限
  └── 点击"删除"按钮 → DELETE /api/users/:id → 后端检查 user:delete 权限
```

### 为什么操作权限是项目级的？

不同项目可能有不同的业务逻辑和权限定义：
- 项目A 需要 `order:export` 权限（导出订单）
- 项目B 不需要这个权限

所以 `sys_permission.project_id` 用于区分不同项目的权限定义。

---

## 菜单同步机制

### 同步流程

```
超管界面 → 点击"同步菜单"按钮
             ↓
    读取 config/menus.ts 中的 platformMenus + superAdminMenus
             ↓
    POST /api/admin/sync-menus
    {
      groups: [{ groupCode, groupTitle, sortOrder }],
      menus: [{ groupCode, menuCode, menuName, icon, path, component, sortOrder }]
    }
             ↓
    后端对比数据库 sys_menu_group 和 sys_menu
             ↓
    执行增删改操作（事务）
             ↓
    返回同步结果
```

### API 设计

**接口**：`POST /api/admin/sync-menus`

**权限**：仅超级管理员可调用

**请求参数**：
```typescript
interface SyncMenusRequest {
  groups: Array<{
    groupCode: string
    groupTitle: string
    sortOrder: number
  }>
  menus: Array<{
    groupCode: string      // 所属分组编码
    menuCode: string
    menuName: string
    icon: string
    path: string
    component: string
    sortOrder: number
  }>
}
```

**响应**：
```typescript
interface SyncMenusResponse {
  success: boolean
  message: string
  data: {
    groups: { added: number; updated: number; deleted: number }
    menus: { added: number; updated: number; deleted: number }
    total: { groups: number; menus: number }
  }
}
```

---

## 数据结构

### 前端菜单配置（src/config/menus.ts）

```typescript
// 平台全量菜单
export const platformMenus: PlatformMenuGroup[] = [
  {
    groupCode: 'console',      // 分组唯一标识
    groupTitle: '控制台',       // 分组标题
    sortOrder: 1,
    children: [
      {
        menuCode: 'dashboard', // 菜单唯一标识
        menuName: '数据看板',   // 菜单名称
        icon: 'dashboard',     // Material Icons 图标
        path: '/dashboard',    // 路由路径
        component: 'Dashboard/Index.vue',
        sortOrder: 1
      }
    ]
  }
]

// 超管专属菜单
export const superAdminMenus: PlatformMenuGroup[] = [...]
```

### 后端存储（12张表）

详见：`docs/数据库设计.md`

### 后端返回数据

```typescript
// 项目上下文
interface CurrentProjectContext {
  id: number
  projectName: string
  roles: RoleItem[]
  permissions: string[]         // 操作权限列表
  visibleMenuCodes: string[]    // 可见菜单 code 列表
}
```

---

## 数据流

```
1. 超管创建项目
   └── 选择项目可用菜单 → 存入 sys_project_menu

2. 项目管理员创建角色
   ├── 选择角色可用菜单分组 → 存入 sys_role_menu_group
   ├── 选择角色可用菜单 → 存入 sys_role_menu
   └── 选择角色操作权限 → 存入 sys_role_permission

3. 用户登录
   ├── 后端计算用户可见菜单 → 返回 visibleMenuCodes
   └── 后端计算用户操作权限 → 返回 permissions

4. 前端渲染
   └── menuStore 根据 visibleMenuCodes 过滤 platformMenus → AppSidebar 渲染

5. API 调用
   └── 后端拦截器检查 permissions → 有权限放行，无权限 403
```

---

## 核心代码

### menuStore（src/stores/menu/index.ts）

```typescript
// 根据 menuCode 过滤菜单
const filteredMenus = computed(() => {
  // 超级管理员：显示所有菜单
  if (authStore.isSuperAdmin) {
    return [...platformMenus, ...superAdminMenus]
  }

  // 普通用户：根据 visibleMenuCodes 过滤
  return filterMenusByCode(visibleMenuCodes.value)
})
```

### filterMenusByCode（src/config/menus.ts）

```typescript
export function filterMenusByCode(visibleCodes: string[]): PlatformMenuGroup[] {
  const codeSet = new Set(visibleCodes)

  return platformMenus
    .map(group => ({
      ...group,
      children: group.children.filter(item => codeSet.has(item.menuCode))
    }))
    .filter(group => group.children.length > 0)
}
```

---

## 添加新菜单

### 步骤

1. **修改前端配置**（src/config/menus.ts）
   ```typescript
   {
     groupCode: 'new_group',
     groupTitle: '新功能',
     children: [
       { menuCode: 'new_feature', menuName: '新功能', icon: 'star', path: '/new' }
     ]
   }
   ```

2. **添加路由**（src/router/index.ts）
   ```typescript
   { path: 'new', name: 'NewFeature', component: () => import('@/views/New/Index.vue') }
   ```

3. **创建页面组件**（src/views/New/Index.vue）

4. **同步菜单**
   - 超管点击"同步菜单"按钮，将前端配置同步到数据库

5. **配置项目菜单**
   - 超管编辑项目，勾选新菜单

6. **配置角色菜单**
   - 项目管理员编辑角色，勾选新菜单

### 无需修改

- 后端代码（只存 menuCode，不关心菜单详情）
- AppSidebar 组件（自动从 menuStore 读取）

---

## 优点

1. **无同步问题** - 菜单定义在前端代码中，通过同步 API 更新到数据库
2. **后端轻量** - 只存 menuCode，不存储冗余信息
3. **层级约束清晰** - 项目 → 角色分组 → 角色菜单 → 用户，逐级收窄
4. **灵活性高** - 不同项目可以有不同的功能模块
5. **安全性高** - 操作权限在后端鉴权，无法绕过

---

## 文件位置

- **建表SQL**：`database/schema-optimized.sql`
- **数据库设计**：`docs/数据库设计.md`
- **任务计划**：`docs/任务计划.md`
- **本文档**：`docs/菜单权限设计.md`

---

## 更新记录

| 日期 | 更新内容 |
|------|----------|
| 2025-12-24 | 创建文档 |
| 2025-12-25 | 更新权限设计，添加菜单权限和操作权限的区别说明 |
| 2025-12-25 | 明确操作权限在后端 API 层面鉴权 |
